services:
  ollama:
    image: ollama/ollama:latest
    volumes:
      - ${OLLAMA_MODELS:-ollama-models}:/root/.ollama
    healthcheck:
      test: ["CMD", "bash", "-c", "cat < /dev/null > /dev/tcp/localhost/11434"]
      interval: 5s
      timeout: 5s
      retries: 10

  kodit:
    image: ${KODIT_IMAGE:-kodit:test}
    depends_on:
      ollama:
        condition: service_healthy
    environment:
      - DISABLE_TELEMETRY=true
      - "DB_URL=sqlite:///:memory:"
      # Embeddings use the built-in jina-embeddings-v2-base-code model (no external API needed)
      - ENRICHMENT_ENDPOINT_BASE_URL=http://ollama:11434/v1
      - ENRICHMENT_ENDPOINT_MODEL=qwen2.5:0.5b
      - ENRICHMENT_ENDPOINT_API_KEY=ollama
      - SKIP_PROVIDER_VALIDATION=true
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/healthz"]
      interval: 5s
      timeout: 3s
      start_period: 10s
      retries: 10

volumes:
  ollama-models:
